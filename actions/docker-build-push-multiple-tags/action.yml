name: Docker Build and Push with Multiple Tags (Latest, Datetime, and Git SHA)
description: Composite action to calculate tags, login to Docker Hub, set up buildx, and build/push Docker images.
author: shanieMoonlight
inputs:
  image_name:
    description: 'Docker image name (e.g. owner/repo)'
    required: true
  dockerfile:
    description: 'Path to Dockerfile'
    required: false
    default: 'Dockerfile'
  context:
    description: 'Build context'
    required: false
    default: '.'
  push:
    description: 'Whether to push the image (true/false)'
    required: false
    default: 'true'
  docker_username:
    description: 'Docker registry username (pass via workflow secrets)'
    required: true
  docker_password:
    description: 'Docker registry password (pass via workflow secrets)'
    required: true
outputs:
  tags:
    description: 'JSON array of tags generated by calculate-docker-tags'
    value: ${{ steps.calc.outputs.tags }}
  digest:
    description: 'Digest of the built Docker image'
    value: ${{ steps.build.outputs.digest }}
runs:
  using: composite
  steps:
    - name: Calculate Tags (Action)
      id: calc
      uses: shanieMoonlight/git-actions/actions/calculate-docker-tags@master
      # uses: ../calculate-docker-tags
      with:
        image_name: ${{ inputs.image_name }}



    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ inputs.docker_username }}
        password: ${{ inputs.docker_password }}

    - name: Set up Docker Buildx (docker-container driver)
      uses: docker/setup-buildx-action@v2
      with:
        driver: docker-container


    - name: Build and push image
      id: build
      uses: docker/build-push-action@v4
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        push: ${{ inputs.push }}
        tags: ${{ steps.calc.outputs.tags_newline_separated }}
        pull: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
